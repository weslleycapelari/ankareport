<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>AnkaReport Dev Server</title>

    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <link rel="stylesheet" href="ankareport.css" />
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="tab.css" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.12.3/ace.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
    <script src="ankareport.js"></script>
    <script src="layout.js"></script>
    <script src="data-source.js"></script>
    <script src="data.js"></script>
    <script src="tab.js"></script>
  </head>
  <body>
    <div class="container">
      <div class="container--tabs">
        <ul class="nav nav-tabs">
          <li class="active">
            <a href="#tab-1">Designer</a>
          </li>
          <li class="">
            <a href="#tab-2">Layout</a>
          </li>
          <li class="">
            <a href="#tab-3">Dataset</a>
          </li>
          <li class="">
            <a href="#tab-4">Data</a>
          </li>
        </ul>
        <div class="tab-content">
          <div id="tab-1" class="tab-pane active">
            <div id="designer"></div>
          </div>
          <div id="tab-2" class="tab-pane">
            <div class="panel-header" style="padding: 0.5rem;">
              <span style="flex: 1">Layout</span>
              <input
                id="load-layout-from-designer"
                type="button"
                value="Load From Designer"
                onclick="loadLayoutFromDesigner()"
              />
              <input
                id="switch-layout"
                type="button"
                value="Show"
                onclick="switchLayout()"
              />
            </div>
            <div class="panel-body" style="flex: 1;">
              <div id="layout-editor"></div>
            </div>
          </div>
          <div id="tab-3" class="tab-pane">
            <div class="panel-header" style="padding: 0.5rem;">Data Source</div>
            <div class="panel-body" style="flex: 1;">
              <div id="data-source-editor"></div>
            </div>
          </div>
          <div id="tab-4" class="tab-pane">
            <div class="panel-header" style="padding: 0.5rem;">Data</div>
            <div class="panel-body" style="flex: 1;">
              <div id="data-editor"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      console.log("AnkaReport Version: " + AnkaReport.version);
      document.title = `AnkaReport ${AnkaReport.version}-dev`;

      var page = 1;
      var designer = null;

      const designerDiv = document.getElementById("designer");

      const loadLayoutFromDesignerButton = document.getElementById(
        "load-layout-from-designer",
      );
      const switchLayoutButton = document.getElementById("switch-layout");
      const dataSourcePanel = document.getElementById("data-source-panel");

      const layoutEditor = ace.edit("layout-editor");
      layoutEditor.session.setMode("ace/mode/json");
      layoutEditor.setValue(JSON.stringify(layout, null, 2), 1);

      const dataSourceEditor = ace.edit("data-source-editor");
      dataSourceEditor.session.setMode("ace/mode/json");
      dataSourceEditor.setValue(JSON.stringify(dataSource, null, 2), 1);

      const dataEditor = ace.edit("data-editor");
      dataEditor.session.setMode("ace/mode/json");
      dataEditor.setValue(JSON.stringify(data, null, 2), 1);

      const refreshDesigner = () => {
        try {
          const layout = JSON.parse(layoutEditor.getValue());
          const dataSource = JSON.parse(dataSourceEditor.getValue());

          designerDiv.innerHTML = "";

          designer = AnkaReport.designer({
            element: designerDiv,
            dataSource,
            layout,
            onSaveButtonClick: (layout) => {
              console.log(layout);
            },
          });
        } catch {}
      };

      layoutEditor.on("change", () => {
        refreshDesigner();
      });
      dataSourceEditor.on("change", () => refreshDesigner());

      refreshDesigner();

      const showDesigner = () => {
        page = 0;
        switchLayoutButton.value = "Show Report";
        designerDiv.style.display = null;
        loadLayoutFromDesignerButton.style.display = null;
      };

      const showReport = () => {
        page = 1;
        switchLayoutButton.value = "Show Designer";
        designerDiv.style.display = "none";
        loadLayoutFromDesignerButton.style.display = "none";
      };

      showDesigner();

      const switchLayout = () => {
        switch (page) {
          case 0:
            showReport();
            break;
          case 1:
            showDesigner();
            break;
        }
      };

      const loadLayoutFromDesigner = () => {
        const layout = designer.toJSON();
        layoutEditor.setValue(JSON.stringify(layout, null, 2), 1);
      };
    </script>
  </body>
</html>
